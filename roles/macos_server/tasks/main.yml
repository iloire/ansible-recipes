# macOS server/agent hardening: energy, security, networking, maintenance

# --- Energy & Reliability ---

- name: Prevent system sleep
  ansible.builtin.command: pmset -a sleep 0
  become: true

- name: Prevent display sleep
  ansible.builtin.command: pmset -a displaysleep 0
  become: true

- name: Prevent disk sleep
  ansible.builtin.command: pmset -a disksleep 0
  become: true

- name: Restart automatically after power failure
  ansible.builtin.command: pmset -a autorestart 1
  become: true

- name: Restart automatically if system freezes
  ansible.builtin.command: pmset -a restartfreeze 1
  become: true
  failed_when: false  # not supported on Apple Silicon; hardware watchdog handles this natively

- name: Disable screen saver
  ansible.builtin.shell: defaults -currentHost write com.apple.screensaver idleTime -int 0

# --- Firewall ---

- name: Enable firewall
  ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
  become: true

- name: Enable firewall stealth mode
  ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on
  become: true

# --- Disable unused services ---

- name: Disable Bluetooth
  ansible.builtin.shell: defaults write /Library/Preferences/com.apple.Bluetooth ControllerPowerState -int 0
  become: true
  when: macos_server_disable_bluetooth | default(true)

- name: Disable AirDrop
  ansible.builtin.shell: defaults write com.apple.NetworkBrowser DisableAirDrop -bool true

- name: Disable Handoff
  ansible.builtin.shell: defaults -currentHost write com.apple.coreservices.useractivityd ActivityReceivingAllowed -bool false

- name: Disable remote Apple events
  ansible.builtin.command: launchctl disable system/com.apple.AEServer
  become: true

# --- Security ---

- name: Require password immediately after sleep or screen saver
  ansible.builtin.shell: defaults write com.apple.screensaver askForPassword -int 1

- name: Set password delay to 0 seconds
  ansible.builtin.shell: defaults write com.apple.screensaver askForPasswordDelay -int 0

- name: Disable guest account
  ansible.builtin.shell: defaults write /Library/Preferences/com.apple.loginwindow GuestEnabled -bool false
  become: true

# --- Networking ---

- name: Enable Remote Login (SSH)
  ansible.builtin.command: systemsetup -setremotelogin on
  become: true

- name: Set hostname
  ansible.builtin.command: "scutil --set ComputerName {{ macos_server_hostname }}"
  become: true
  when: macos_server_hostname is defined

- name: Set local hostname
  ansible.builtin.command: "scutil --set LocalHostName {{ macos_server_hostname }}"
  become: true
  when: macos_server_hostname is defined

# --- Maintenance ---

- name: Install daily periodic maintenance launchd plist
  ansible.builtin.template:
    src: com.local.periodic-daily.plist.j2
    dest: /Library/LaunchDaemons/com.local.periodic-daily.plist
    owner: root
    group: wheel
    mode: "0644"
  become: true

- name: Load daily periodic maintenance daemon
  ansible.builtin.command: launchctl load -w /Library/LaunchDaemons/com.local.periodic-daily.plist
  become: true
  changed_when: false

- name: Install weekly restart launchd plist
  ansible.builtin.template:
    src: com.local.weekly-restart.plist.j2
    dest: /Library/LaunchDaemons/com.local.weekly-restart.plist
    owner: root
    group: wheel
    mode: "0644"
  become: true
  when: macos_server_weekly_restart | default(false)

- name: Load weekly restart daemon
  ansible.builtin.command: launchctl load -w /Library/LaunchDaemons/com.local.weekly-restart.plist
  become: true
  changed_when: false
  when: macos_server_weekly_restart | default(false)
